<!DOCTYPE html>
<html>
  <head>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
      type="text/javascript"
    ></script>
    <title>Lab 5</title>
  </head>
  <body>
    <script type="text/javascript" src="js/webcam.min.js"></script>
    <h1>Lab 5 in DM2518</h1>
    <p>This lab is testing out MQTT and other APIs.</p>

    <div id="my_camera"></div>
    <br />
    <!--<input type="button" value="Take Snapshot" onClick="take_snapshot()" />-->
    <br />
    <div id="results"></div>

    <script type="text/javascript" src="js/webcam.min.js"></script>
    <script language="JavaScript">
      function take_snapshot() {
        // take snapshot and get image data
        Webcam.snap(function (data_uri) {
          // display results in page
          publish(sendto, data_uri);
        });
      }

      Webcam.set({
        width: 320,
        height: 240,
        image_format: "jpeg",
        jpeg_quality: 50,
        flip_horiz: true
      });
      Webcam.attach("#my_camera");

      function onConnect() {
        client.subscribe(myTopic);
        client.subscribe(myTopic2);
        console.log("connection successful");
        setInterval(() => {
          take_snapshot();
        }, 10000);
      }

      const publish = (topic, msg) => {
        //takes topic and message string
        let message = new Paho.MQTT.Message(msg);
        message.destinationName = topic;
        client.send(message);
      };

      function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("onConnectionLost:" + responseObject.errorMessage);
        }
        client.connect({ onSuccess: onConnect });
      }

      //  [["person", 0.9918680787086487, [4, 24, 279, 248]]]
      function onMessageArrived(message) {
        console.log(
          "Got message on topic " +
            message.destinationName +
            " with payload: " +
            message.payloadString
          //JSON parse
        );
        if (message.destinationName === myTopic) {
          handlePic(message.payloadString);
        }
        if (message.destinationName === myTopic2) {
          handleReply(JSON.parse(message.payloadString)[0][0]);
        }
      }

      function handlePic(pic) {
        document.getElementById("results").innerHTML =
          "<h2>Here is your image:</h2>" + '<img src="' + pic + '"/>';
      }

      function handleReply(txt) {
        if (txt === "person") {
          speak("En människa!");
        }
        if (txt === "teddy bear" || txt === "dog") {
          speak("Gullig!");
        }
        if (txt === "cup" || txt === "bottle") {
          speak("Nånting drickbart!");
        }
        if (txt === "pottedplant" || txt === "vase") {
          speak("Den var fin.");
        }
        if (txt === "cell phone") {
          speak("Kul telefon.");
        }
      }

      function speak(text) {
        speechSynthesis.speak(new SpeechSynthesisUtterance(text));
      }

      //    const client = new Paho.MQTT.Client("ws://mqtt.eclipse.org/mqtt", "myJSClientId" + new Date().getTime());
      const client = new Paho.MQTT.Client(
        "ws://test.mosquitto.org:8080/mqtt",
        "kth/dm2518/yolo3/jk960818/imgb64"
      );
      const sendto = "kth/dm2518/yolo3/jk960818/imgb64";
      const myTopic = "kth/dm2518/reply/yolo3/jk960818/imgb64";
      const myTopic2 = "kth/dm2518/reply/yolo3/jk960818/json";
      client.onMessageArrived = onMessageArrived;
      client.onConnectionLost = onConnectionLost;
      client.connect({ onSuccess: onConnect });
    </script>
  </body>
</html>

// person, pottedplant, vase, teddy bear, dog, cell phone
